{% extends 'super_moite_moite/base_super_moite_moite.html' %}

{% load static i18n %}

{% block super_moite_moite_title %}{{ logement }}{% endblock %}

{% block jumbotron_title %}{{ logement }}{% endblock %}
{% block jumbotron_description %}
    Habitants :
    {% for habitant in logement.habitants.all %}
        <a href="{{ habitant.get_absolute_url }}">{{ habitant }}</a>{% if not forloop.last %}{% if logement.habitants.count != 2 %}, {% else %} & {% endif %}{% endif %}
    {% endfor %}
    <a href="{% url 'super-moite-moite:edition-logement' logement.slug %}" class="btn btn-default btn-sm"
       title="Editer les informations du logement">
        <i class="fa fa-edit"></i>
    </a>
{% endblock %}

{% block stylesheet %}
    <link rel="stylesheet" href="{% static 'super_moite_moite/css/style.css' %}">
{% endblock %}

{% block content %}
    <div id="app">
        <div class="container">
            <div class="row">
                <div class="col-md-8 col-md-offset-2 col-xs-12">
                    <ul class="nav nav-pills nav-justified">
                        <li class="active">
                            <a data-toggle="pill" href="#home">Tâches</a>
                        </li>
                        <li>
                            <a data-toggle="pill" href="#statistiques">Statistiques</a>
                        </li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="tab-content">
                <div id="home" class="row tab-pane fade in active">
                    <div v-for="categorie in logement.categories" class="col-md-3 col-sm-4 col-xs-12">
                        <div class="well" :style="{backgroundColor: categorieEnEdition === categorie.id && couleurCategorieEdition !== ''? couleurCategorieEdition : categorie.couleur}">
                            <h4 class="text-center showOnHover" @click="editionCategorie(categorie)"
                                :style="{display: categorieEnEdition === categorie.id ? 'none' : 'block'}"
                                title="Cliquer pour éditer la catégorie">
                                [[ categorie.nom ]]
                                <i class="fa fa-pencil"></i>
                            </h4>
                            <div :style="{display: categorieEnEdition === categorie.id ? 'block' : 'none'}">
                                <div :class="'form-group' + (erreursNomCategorieEdition.length ? ' has-error' : '')">
                                    <input v-model="nomCategorieEdition" class="form-control">
                                    <ul v-if="erreursNomCategorieEdition.length" class="errorlist">
                                        <li v-for="erreur in erreursNomCategorieEdition">[[ erreur ]]</li>
                                    </ul>
                                </div>
                                <div :class="'form-group' + (erreursCouleurCategorieEdition.length ? ' has-error' : '')">
                                    <div class="row">
                                        <div class="col-xs-7">
                                            <input v-model="couleurCategorieEdition" class="form-control">
                                        </div>
                                        <div class="col-xs-5">
                                            <input v-model="couleurCategorieEdition" class="form-control" type="color">
                                        </div>
                                    </div>
                                    <ul v-if="erreursCouleurCategorieEdition.length" class="errorlist">
                                        <li v-for="erreur in erreursCouleurCategorieEdition">[[ erreur ]]</li>
                                    </ul>
                                </div>
                                <div class="text-center">
                                    <button type="button" class="btn btn-default" @click="enregistreEditionCategorie(categorie)">
                                        OK <i class="fa fa-save"></i>
                                    </button>
                                    <button type="button" class="btn btn-warning" @click="categorieEnEdition = null">
                                        Annuler
                                    </button>
                                </div>
                            </div>
                            <p v-for="habitant in logement.habitants">
                                [[ habitant.user ]] : [[ pointsCategorieProfil(categorie, habitant) ]] points
                            </p>
                            <hr>
                            <div class="panel panel-default" v-for="tache in categorie.taches">
                                <div class="panel-heading">
                                    <a @click="detailTache(tache)">
                                        [[ tache.nom ]]
                                    </a>
                                </div>
                                <div class="panel-body">
                                    <div v-if="!tache.get_photo_url.includes('placeholder.jpg')">
                                        <img :src="tache.get_photo_url" :alt="'Photo de la tâche ' + tache.nom" :style="{width: '100%'}">
                                    </div>
                                    <p v-if="tache.description">[[ tache.description ]]</p>
                                    <p>
                                        Tracks : [[ tache.tracks.length ]]
                                    </p>
                                    <div v-for="habitant in logement.habitants">
                                        [[ habitant.user ]] ([[ pointParDefautProfil(tache, habitant) ]]pt[[ pointParDefautProfil(tache, habitant) > 1 ? 's' : '' ]])
                                        <i class="fa fa-arrow-right" style="font-size: 10px"></i>
                                        <div class="badge">[[ pointsTacheProfil(tache, habitant) ]]</div>
                                    </div>
                                </div>
                                <div class="panel-footer text-center">
                                    <div class="btn-group">
                                        <button @click="ajoutTrack(tache)" type="button" class="btn btn-primary btn-xs">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                        <button @click="detailTache(tache, true)" type="button" class="btn btn-default btn-xs">
                                            <i class="fa fa-comment"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group">
                                <input v-model="nomsNouvelleTache[categorie.id]" @keyup.enter="nouvelleTache(categorie)"
                                       placeholder="Nouvelle tâche" class="form-control">
                                <div class="input-group-btn">
                                    <div @click="nouvelleTache(categorie)" class="btn btn-default">
                                        <i class="fa fa-check"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-4 col-xs-12">
                        <div class="well">
                            <div class="input-group">
                                <input v-model="nomNouvelleCategorie" @keyup.enter="nouvelleCategorie"
                                       placeholder="Nouvelle catégorie" class="form-control">
                                <div class="input-group-btn">
                                    <div @click="nouvelleCategorie" class="btn btn-primary">
                                        <i class="fa fa-plus"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="statistiques" class="row tab-pane fade">
                    <div class="col-xs-12">
                        <h2 class="text-center">Points par habitants</h2>
                        <div class="progress">
                            <div v-for="(habitant, index) in logement.habitants" :class="(habitant.id === idProfilConnecte ? 'progress-bar-striped active ' : '') + 'progress-bar progress-bar-' + bootstrapClassColors[index]"
                                 role="progressbar" :style="'width:' + pourcentagePointProfil(habitant) + '%'">
                                [[ habitant.user ]] ([[ pourcentagePointProfil(habitant) | round(2) ]]%)
                            </div>
                        </div>
                    </div>
                    <div v-for="(habitant, index) in logement.habitants" class="col-md-6 col-xs-12">
                        <div :class="'panel panel-default panel-' + bootstrapClassColors[index]">
                            <div class="panel-heading text-center">
                                [[ habitant.user ]]
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-xs-6 text-center">
                                        Tracks : <b>[[ totalProfilTracks(habitant) ]]</b>
                                    </div>
                                    <div class="col-xs-6 text-center">
                                        Points : <b>[[ pointsProfil(habitant) ]]</b>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="panel panel-default">
                            <div class="panel-heading text-center">
                                Total
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-xs-6 text-center">
                                        Tracks : <b>[[ totalTracks() ]]</b>
                                    </div>
                                    <div class="col-xs-6 text-center">
                                        Points : <b>[[ totalPoints() ]]</b>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Détail Tâche -->
        <div id="modalDetailTache" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">
                            [[ tacheEditee.nom ]]
                        </h4>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#detail">Détail</a></li>
                            <li><a data-toggle="tab" href="#tracks">Tracks</a></li>
                            <li><a data-toggle="tab" href="#edition">Edition</a></li>
                        </ul>

                        <div class="tab-content">
                            <div id="detail" class="tab-pane fade in active">
                                <h4>Informations sur la tâche</h4>
                                <div class="row">
                                    <div class="col-md-4 col-md-offset-4 col-sm-6 col-sm-offset-3 col-xs-12">
                                        <img :src="tacheEditee.get_photo_url" :alt="'Photo de la tâche ' + tacheEditee.nom" :style="{width: '100%'}">
                                    </div>
                                </div>
                                <p v-if="tacheEditee.description">
                                    Description : [[ tacheEditee.description ]]
                                </p>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th class="text-right">Habitant</th>
                                            <th class="text-center">Points attribués</th>
                                            <th class="text-center">Points gagnés</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="habitant in logement.habitants">
                                            <td class="text-right">
                                                <label :for="habitant.id">[[ habitant.user ]] :</label>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" min="0" class="form-control" :id="habitant.id"
                                               :value="pointParDefautProfil(tacheEditee, habitant)"
                                                @input="changePointParDefautProfil(tacheEditee, habitant, $event.target.value)">
                                            </td>
                                            <td class="text-center">
                                                {# FIXME bug quand on édite les points par défaut #}
                                                [[ pointsTacheProfil(tacheEditee, habitant) ]]
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="tracks" class="tab-pane fade">
                                <h4>Historique des tracks</h4>
                                <div class="form-group">
                                    <label for="commentaire">Ajout d'un nouveau track :</label>
                                    <div class="input-group">
                                        <input @keyup.enter="ajoutTrack(tacheEditee)" v-model="commentaireTrack"
                                               class="form-control" id="commentaire" placeholder="Commentaire facultatif">
                                        <div class="input-group-btn">
                                            <button @click="ajoutTrack(tacheEditee)" type="button" class="btn btn-primary">
                                                <i class="fa fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Profil</th>
                                            <th>Commentaire</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="track in tacheEditee.tracks">
                                            <td>[[ track.datetime | moment ]]</td>
                                            <td>[[ logement.habitants.find(habitant => habitant.id === track.profil).user ]]</td>
                                            <td>[[ track.commentaire ]]</td>
                                            <td>
                                                <button type="button" class="btn btn-default">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="edition" class="tab-pane fade">
                                <h4>Modification des informations de la tâche</h4>
                                <div class="form-group">
                                    <label for="nomInput">
                                        Nom :
                                    </label>
                                    <input v-model="tacheEditee.nom" class="form-control" id="nomInput">
                                </div>
                                <div class="form-group">
                                    <label for="descriptionTextarea">
                                        Descrption :
                                    </label>
                                    <textarea v-model="tacheEditee.description" class="form-control" id="descriptionTextarea" :style="{resize: 'vertical'}"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="imageInput">
                                        Illustration :
                                    </label>
                                    <div>
                                        <input v-model="tacheEditee.photo" class="form-control" id="imageInput">
                                        <input type="file" name="files[]" :style="{display: 'inline'}">
                                        <button @click="uploadFirebaseImage(tacheEditee.id)" type="button" class="btn btn-default">
                                            Upload
                                        </button>
                                        <progress value="0" max="100" :style="{display: tacheEditee.displayProgress}"></progress>
                                        <br>
                                        <img class="display" :src="tacheEditee.get_photo_url" width="340px" alt="Image chargée par Firebase"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @click="enregistrerModifTache(tacheEditee)" type="button" class="btn btn-success">
                            Enregistrer les modifications
                        </button>
                        <button @click="supprimerTache(tacheEditee)" type="button" class="btn btn-danger">
                            Supprimer la tâche
                        </button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    {{ json|json_script:'logement' }}
    {{ request.user.profil.id|json_script:'idProfilConnecte' }}

    {% if debug %}
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    {% else %}
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
    {% endif %}

    <!-- Use lodash for the deep copy -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <!-- Use moment for the date formating -->
    <script src="{% static 'js/moment-with-locales.js' %}"></script>

    <script>
        {% get_current_language as LANGUAGE_CODE %}
        moment.locale('{{ LANGUAGE_CODE }}');
    </script>

    <script src="{% static 'super_moite_moite/js/vue.js' %}"></script>
{% endblock %}