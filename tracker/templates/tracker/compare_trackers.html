{% extends 'tracker/base_tracker.html' %}

{% load custom_tags fontawesome admin_urls static i18n %}

{% block tracker_title %}Comparer Trackers{% endblock %}

{% block stylesheet %}
    {{ block.super }}
    {{ form.media.css }}
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-8 col-md-offset-2 col-xs-12">
            <div class="text-center">
                <h1>Comparer des trackers</h1>
            </div>

            <form method="get">
                <div class="form-group">
                    {{ form.trackers.label_tag }}
                    <div class="row">
                        <div class="col-sm-10 col-xs-12">
                            {{ form.trackers }}
                            {{ form.trackers.errors }}
                        </div>
                        <div class="col-sm-2 col-xs-12">
                            <button type="submit" class="btn btn-primary btn-block">
                                Valider
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <hr>

            <div class="form-group">
                <label for="dates">Filtrer les résultats selon deux dates :</label>
                <input type="text" name="dates" id="dates" class="form-control" />
            </div>

            <ul class="nav nav-tabs nav-justified">
                <li class="active"><a data-toggle="tab" href="#statistiques">Statistiques</a></li>
                <li><a data-toggle="tab" href="#historique">Historique</a></li>
            </ul>

            <div class="tab-content">
                <div id="historique" class="tab-pane fade">
                    <h2>Historique <small><span id="trackCount"></span> {{ tracker.nom|lower }}s</small></h2>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>Tracker</th>
                                <th>Date</th>
                                <th>Commentaire</th>
                            </tr>
                            </thead>
                            <tbody id="tracks">
                            {# Will be filled in AJAX #}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="statistiques" class="tab-pane fade in active">
                    <h2>Statistiques</h2>
                    <div id="track_gaph"{% if not trackers %} class="hidden" {% endif %}>
                        <p>
                            <strong id="avg"></strong> {{ tracker.nom|lower }} par <span id="frequency"></span>
                        </p>
                        <div class="text-center">
                            <canvas id="allTracks" width="600" height="400"></canvas>
                        </div>
                        <div class="row">
                            <div class="col-md-2 col-xs-6 text-center">
                                <button type="button" class="btn btn-default btn-frequency" data-frequency="H">Heure</button>
                            </div>
                            <div class="col-md-2 col-xs-6 text-center">
                                <button type="button" class="btn btn-default btn-frequency" data-frequency="D" id="default">Jour</button>
                            </div>
                            <div class="col-md-2 col-xs-6 text-center">
                                <button type="button" class="btn btn-default btn-frequency" data-frequency="W">Semaine</button>
                            </div>
                            <div class="col-md-2 col-xs-6 text-center">
                                <button type="button" class="btn btn-default btn-frequency" data-frequency="M">Mois</button>
                            </div>
                            <div class="col-md-2 col-xs-6 text-center">
                                <button type="button" class="btn btn-default btn-frequency" data-frequency="Q">Quart d'année</button>
                            </div>
                            <div class="col-md-2 col-xs-6 text-center">
                                <button type="button" class="btn btn-default btn-frequency" data-frequency="Y">Année</button>
                            </div>
                        </div>
                    </div>
                    <div class="well hidden text-danger text-center" id="noTracks">
                        Aucun track pour la période donnée.
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
    <script src="{% static 'js/moment-with-locales.js' %}"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    {{ form.media.js }}
    <script>
        {% get_current_language as LANGUAGE_CODE %}
        moment.locale('{{ LANGUAGE_CODE }}');

        let allTracks = undefined;
        let trackByHourChart = undefined;
        let trackByDayChart = undefined;
        let start = moment().subtract(1, 'month');
        let end = moment();
        const minDate = moment("{{ first_track.datetime|date:"c" }}");
        const maxDate = moment("{{ last_track.datetime|date:"c" }}").add(1, 'minute');

        const trackerIds = [{% for tracker in trackers %}'{{ tracker.id }}',{% endfor %}];
        const frequency_map = {
            H: 'heure',
            D: 'jour',
            W: 'semaine',
            M: 'mois',
            Q: "quart d'année",
            Y: 'an',
        };

        $(() => {
            function daterange_callback(s, e) {
                $('#reportrange span').html(s.format('LLLL') + ' - ' + e.format('LLLL'));
                start = s.format('YY-MM-DD HH:mm:ss');
                end = e.format('YY-MM-DD HH:mm:ss');
                update_all($('button.btn-frequency.active').data('frequency'))
            }

            $('input[name="dates"]').daterangepicker({
                showDropdowns: true,
                timePicker: true,
                timePicker24Hour: true,
                startDate: start,
                endDate: end,
                minDate: minDate,
                maxDate: maxDate,
                locale: {
                    format: 'LLLL',
                    applyLabel: "OK",
                    cancelLabel: "Annuler",
                    fromLabel: "From",
                    toLabel: "To",
                    customRangeLabel: "Personnalisé",
                    weekLabel: "W",
                    daysOfWeek: [
                        "Di",
                        "Lu",
                        "Ma",
                        "Me",
                        "Je",
                        "Ve",
                        "Sa"
                    ],
                    monthNames: [
                        "Janvier",
                        "Février",
                        "Mars",
                        "Avril",
                        "Mai",
                        "Juin",
                        "Juillet",
                        "Août",
                        "Septembre",
                        "Octobre",
                        "Novembre",
                        "Décembre"
                    ]
                },
                ranges: {
                   'Les 7 derniers jours': [moment().subtract(6, 'days'), moment()],
                   'Les 30 derniers jours': [moment().subtract(1, 'month'), moment()],
                   'Les 3 derniers mois': [moment().subtract(3, 'month'), moment()],
                   'Les 6 derniers mois': [moment().subtract(6, 'month'), moment()],
                   'Les 12 derniers mois': [moment().subtract(1, 'year'), moment()],
                   'Tous': [minDate, maxDate],
                }
            }, daterange_callback);

            allTracks = new Chart(document.getElementById("allTracks"), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: []
                    }]
                },
                options: {
                    legend: {
                        display: true
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });

            daterange_callback(start, end);

            $('.btn-frequency').click(function () {
                update_track_graph($(this).data('frequency'), start, end)
            });

            // Trigger the default one
            $('.btn-frequency#default').trigger('click');
        });

        const update_track_graph = frequency => {
            $.post("{% url 'tracker:tracker-data' %}", {id: trackerIds, frequency: frequency, start: start, end: end})
                .done(response => {
                    if (response.labels.length > 0) {
                        $('div#noTracks').addClass('hidden');
                        $('div#track_gaph').removeClass('hidden');
                        allTracks.data.labels = response.labels;
                        allTracks.data.datasets = response.datasets;
                        allTracks.update();
                        $('span#frequency').text(frequency_map[frequency]);
                        $('strong#avg').text(response.averages[0].avg);
                        $('.btn-frequency').removeClass('active');
                        $('.btn-frequency[data-frequency=' + frequency + ']').addClass('active')
                    } else {
                        $('div#track_gaph').addClass('hidden');
                        $('div#noTracks').removeClass('hidden');
                    }
                })
                .fail((xhr, textStatus, errorThrown) => {
                    console.error( '(' + errorThrown + ') ' + (xhr.responseJSON !== undefined ? xhr.responseJSON.error : textStatus));
                });
        };

        const update_all = frequency => {
            update_track_graph(frequency);

            $.post("{% url 'tracker:tracker-history' %}", {id: trackerIds, start: start, end: end})
                .done(response => {
                    $('tbody#tracks').html(response.html);
                    $('span#trackCount').text(response.trackCount);
                })
                .fail((xhr, textStatus, errorThrown) => {
                    console.error( '(' + errorThrown + ') ' + (xhr.responseJSON !== undefined ? xhr.responseJSON.error : textStatus));
                });
        }
    </script>
{% endblock %}